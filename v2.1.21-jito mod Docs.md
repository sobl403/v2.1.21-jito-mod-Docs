## Overview 
Документация описывает [Vote Optimized Mod](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446) для [jito-solana-client v2.1.21](https://github.com/jito-foundation/jito-solana/tree/v2.1.21-jito). Основная цель: снизить количество Missed Vote Credits перед Skipped Slots.  
![[Pasted image 20250516115124.png]]
### [`core/src/replay_stage`](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-6d8458bb2e53158ac472a9ad4709e6a0a52b75d930c019013298e8acda133828) Основной алгоритм оптимизации голосования и выбора форков.
[`run_replay`](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-6d8458bb2e53158ac472a9ad4709e6a0a52b75d930c019013298e8acda133828R540-R541)
До: валидатор принимал решение о голосовании на основании одного vote_bank. 
После: при включенной функции [threshold voting ](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-0b654209e209924bfc70e8dd4c84d0979e36b6ca76e85a5899ba4572521a8170R706) используется улучшенная логика выбора банков и форков. Добавлена логика отчистки `Tower` от голосов, оказавшихся на отличных от выбранного форка, явное удаление истекших голосов (`pop_expired=true`) 
#### Logics
Инициализируется хранилище банков, за которые в последствии валидатор будет голосовать. Если значение в поле `threshold_ahead_count` существует, получаем последний слот, за который голосовал валидатор и проверяем существует ли значение в поле `mostly_confirmed_bank`, если значение и последний слот, за который голосовал валидатор существуют в хранилище банков добавляются все банки между `most_recent_voted_slot` и  `mostly_confirmed_bank_parent` в формате: `(most_recent_voted_slot, mostly_confirmed_bank_parent]`. Независимо от того, существует ли последний проголосованный слот, в хранилище банков добавляются банки в диапазоне от `mostly_confirmed_bank` до `threshold_ahead_count`. 
Для банков в хранилище банков применяется следующая фильтрация: 
1) Удаляются банки за которые уже был отдан голос.
2) Удаляются [locked](https://docs.anza.xyz/implemented-proposals/tower-bft#lockouts) банки.
3) Если включена функция `after_skip_threshold` удаляет банки, которые не набрали `is_mostly_confirmed`или`duplicate_confirmed` (в зависимости от конфигурации)
4) Удаляет все остальные, кроме первых 31 банка, не отфильтрованных пунктами 1-3.
Удаляются все банки, которые увеличат количество блокировок от `mostly_confirmed_slot` до >64. Сперва удаляются новые банки, чтобы при снятии блокировки за них можно было проголосовать. 
Если после применения фильтрации хранилище банков пустое, проверяем есть ли значение в поле `threshold_escape_count`, если есть, отбираем банки в диапазоне `recent_voted_slot..threshold_escape_count`. 
Для каждого vote в структуре Tower проверяем, является ли `vote.slot()` предком банка нашего последнего голоса если нет, то удаляем, так как они находятся на другом форке. 
![[vote_optimized_algo_replay_stage.svg]]

[`handle_voteable_banks`](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-6d8458bb2e53158ac472a9ad4709e6a0a52b75d930c019013298e8acda133828R540-R541)
До: обработка одного банка.
После: Обработка списка банков. 
### [`core/src/consensus.rs`](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-0b654209e209924bfc70e8dd4c84d0979e36b6ca76e85a5899ba4572521a8170) . Обновление структуры Tower. Загрузка конфигурации оптимизации голосования.
[`Tower`](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-0b654209e209924bfc70e8dd4c84d0979e36b6ca76e85a5899ba4572521a8170R283) 
Добавлены поля управляющие оптимизацией голосования. 
Добавлена функция [`update_config`](https://github.com/gabrielhicks/jito-solana-public/commit/060ab96ffa0c6b825ad4690797eb5514eaa32446#diff-0b654209e209924bfc70e8dd4c84d0979e36b6ca76e85a5899ba4572521a8170R699). Не чаще чем раз в минуту проверяет наличие и считывает конфигурацию из файла `./mostly_confirmed_threshold`.
Формат записи: a b c d, где 
- a = `mostly_confirmed_threshold: f64` - порог подтверждения, по умолчанию устанавливается в 0.38.
- b = `threshold_ahead_count: u8` - позволяет голосовать за слоты впереди слота, набравшего `mostly_confirmed_threshold`.
- с = `after_skip_threshold: u8` - требование по проценту набранных голосов для слота после Skipped Slots. 0 - нет ограничений, 1 - `is_mostly_confirmed`, 2 - `is_supermajority_confirmed`.
- d = `threshold_escape_count: u8` - Количество слотов, после которых валидатор проголосует в любом случае, даже если порог не достигнут, чтобы избежать тупиковых ситуаций в сети.